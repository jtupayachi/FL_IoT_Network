#!/bin/bash
# 4-Method Parallel Orchestration for MLP (OFFSET) - SIMPLIFIED (1 varying parameter per method)
# MOON, FedALA, StatAvg, DASHA running in parallel

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0m'
NC='\033[0m'

EXPERIMENT_NAME="4METHODS_MLP_SIMPLE_$(date +%Y%m%d_%H%M%S)"
LOG_DIR="/home/jose/FL_IoT_Network/logs/${EXPERIMENT_NAME}"
mkdir -p "${LOG_DIR}"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  4-Method Parallel FL Experiments - MLP (OFFSET)${NC}"
echo -e "${BLUE}  1 varying parameter per method${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Check if containers are running and have GPU
echo -e "${YELLOW}Checking container status...${NC}"
if sudo docker ps | grep -q "fl_moon_server"; then
    # Check if GPU is available
    if sudo docker exec fl_moon_server python3 -c "import tensorflow as tf; exit(0 if tf.config.list_physical_devices('GPU') else 1)" 2>/dev/null; then
        echo -e "${GREEN}âœ“ Containers running with GPU - keeping them${NC}\n"
        SKIP_DATA=true
    else
        echo -e "${YELLOW}âš  Containers running without GPU - restarting${NC}"
        sudo docker compose -f docker-compose-4methods.yml down
        sudo docker compose -f docker-compose-4methods.yml up -d
        sleep 10
        echo -e "${GREEN}âœ“ Containers restarted${NC}\n"
        SKIP_DATA=false
    fi
else
    echo -e "${YELLOW}Starting containers...${NC}"
    sudo docker compose -f docker-compose-4methods.yml up -d
    sleep 10
    echo -e "${GREEN}âœ“ Containers started${NC}\n"
    SKIP_DATA=false
fi

# Prepare data splits (run once in moon_server)
if [ "$SKIP_DATA" = false ]; then
    echo -e "${YELLOW}Preparing MLP data splits...${NC}"
    alphas="0.001 0.01 0.1 1.0"

    for alpha in $alphas; do
        sudo docker exec fl_moon_server bash -c "
            cd /workspace && \
            python3 fl_testbed/version2/client/dirichelet_split.py \
            -data_X_train 100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_train.pkl \
            -data_X_vals 100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_vals.pkl \
            -data_y_train 100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_train.pkl \
            -data_y_vals 100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_vals.pkl \
            -cm 5 -alpha ${alpha} -beta 0.2 -motor 3 -type MLP
        " 2>&1 | tee ${LOG_DIR}/datasplit_mlp_${alpha}.log
    done
    echo -e "${GREEN}âœ“ MLP Data splits prepared${NC}\n"

    # Run independent training (once)
    echo -e "${YELLOW}Running independent training for MLP...${NC}"
    for client in 0 1 2 3 4; do
        sudo docker exec fl_moon_server bash -c "
            cd /workspace && \
            python3 fl_testbed/version2/client/independent.py -ml 1 -cn 15 -cm 15 -e 30 \
            -dfn 'M3_5_${client}_ddf_MLP.pkl' \
            -dfn_test_x '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_test.pkl' \
            -dfn_test_y '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_test.pkl' \
            -ip 172.18.1.10
        " 2>&1 | tee ${LOG_DIR}/independent_mlp_client${client}.log &
    done
    wait
    echo -e "${GREEN}âœ“ Independent training done${NC}\n"
else
    echo -e "${BLUE}âŠ™ Skipping data preparation (already done)${NC}\n"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Create method-specific server scripts with ONLY 1 VARYING PARAMETER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# MOON: Base port 8080
cat > /tmp/moon_server_mlp.sh << 'EOF'
#!/bin/bash
cd /workspace
alphas="0.001 0.01 0.1 1.0"
tau_values="0.01 0.1 1.0"

PORT=8080
for alpha in $alphas; do
    for tau_val in $tau_values; do
        echo "MLP MOON - alpha: $alpha, tau: $tau_val (port: $PORT)"
        python3 fl_testbed/version2/server/federated_server_OFFSET_MOON.py \
            -mu 1.0 -temperature 0.5 -tau ${tau_val} -slr 0.01 -cm 5 -e 1 --rounds 100 \
            -ip 172.18.1.10:$PORT \
            -dfn_test_x '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_test.pkl' \
            -dfn_test_y '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_test.pkl' \
            -dfn 'M3_5_0_ddf_MLP.pkl' \
            2>&1 | tee MLP_MOON_alpha_${alpha}_tau_${tau_val}.txt
        echo "MLP MOON alpha=$alpha tau=$tau_val done"
        PORT=$((PORT + 1))
        sleep 2
    done
done
echo "=== MLP MOON ALL DONE ==="
EOF

# FedALA: Base port 9000
cat > /tmp/fedala_server_mlp.sh << 'EOF'
#!/bin/bash
cd /workspace
alphas="0.001 0.01 0.1 1.0"
tau_values="0.01 0.1 1.0"

PORT=9000
for alpha in $alphas; do
    for tau_val in $tau_values; do
        echo "MLP FedALA - alpha: $alpha, tau: $tau_val (port: $PORT)"
        python3 fl_testbed/version2/server/federated_server_OFFSET_FedALA.py \
            -tau ${tau_val} -slr 0.01 -cm 5 -e 1 --rounds 100 \
            -ip 172.18.2.10:$PORT \
            -dfn_test_x '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_test.pkl' \
            -dfn_test_y '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_test.pkl' \
            -dfn 'M3_5_0_ddf_MLP.pkl' \
            2>&1 | tee MLP_FedALA_alpha_${alpha}_tau_${tau_val}.txt
        echo "MLP FedALA alpha=$alpha tau=$tau_val done"
        PORT=$((PORT + 1))
        sleep 2
    done
done
echo "=== MLP FedALA ALL DONE ==="
EOF

# StatAvg: Base port 10000
cat > /tmp/statavg_server_mlp.sh << 'EOF'
#!/bin/bash
cd /workspace
alphas="0.001 0.01 0.1 1.0"
slr_values="0.001 0.01 0.1"

PORT=10000
for alpha in $alphas; do
    for slr_val in $slr_values; do
        echo "MLP StatAvg - alpha: $alpha, slr: $slr_val (port: $PORT)"
        python3 fl_testbed/version2/server/federated_server_OFFSET_StatAvg.py \
            -tau 1.0 -slr ${slr_val} -cm 5 -e 1 --rounds 100 \
            -ip 172.18.3.10:$PORT \
            -dfn_test_x '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_test.pkl' \
            -dfn_test_y '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_test.pkl' \
            -dfn 'M3_5_0_ddf_MLP.pkl' \
            2>&1 | tee MLP_StatAvg_alpha_${alpha}_slr_${slr_val}.txt
        echo "MLP StatAvg alpha=$alpha slr=$slr_val done"
        PORT=$((PORT + 1))
        sleep 2
    done
done
echo "=== MLP StatAvg ALL DONE ==="
EOF

# DASHA: Base port 11000
cat > /tmp/dasha_server_mlp.sh << 'EOF'
#!/bin/bash
cd /workspace
alphas="0.001 0.01 0.1 1.0"
slr_values="0.001 0.01 0.1"

PORT=11000
for alpha in $alphas; do
    for slr_val in $slr_values; do
        echo "MLP DASHA - alpha: $alpha, slr: $slr_val (port: $PORT)"
        python3 fl_testbed/version2/server/federated_server_OFFSET_DASHA.py \
            -tau 1.0 -slr ${slr_val} -cm 5 -e 1 --rounds 100 \
            -ip 172.18.4.10:$PORT \
            -dfn_test_x '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedX_test.pkl' \
            -dfn_test_y '100_1_15_15_combined_offset_misalignment_M3.csv__client_centralizedy_test.pkl' \
            -dfn 'M3_5_0_ddf_MLP.pkl' \
            2>&1 | tee MLP_DASHA_alpha_${alpha}_slr_${slr_val}.txt
        echo "MLP DASHA alpha=$alpha slr=$slr_val done"
        PORT=$((PORT + 1))
        sleep 2
    done
done
echo "=== MLP DASHA ALL DONE ==="
EOF

# Copy scripts to containers
sudo docker cp /tmp/moon_server_mlp.sh fl_moon_server:/workspace/
sudo docker cp /tmp/fedala_server_mlp.sh fl_fedala_server:/workspace/
sudo docker cp /tmp/statavg_server_mlp.sh fl_statavg_server:/workspace/
sudo docker cp /tmp/dasha_server_mlp.sh fl_dasha_server:/workspace/

# Clean up old result files
echo -e "${YELLOW}Cleaning up old result files...${NC}"
sudo docker exec fl_moon_server bash -c "cd /workspace && rm -f MLP_*.txt"
sudo docker exec fl_fedala_server bash -c "cd /workspace && rm -f MLP_*.txt"
sudo docker exec fl_statavg_server bash -c "cd /workspace && rm -f MLP_*.txt"
sudo docker exec fl_dasha_server bash -c "cd /workspace && rm -f MLP_*.txt"
echo -e "${GREEN}âœ“ Old files cleaned${NC}\n"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  LAUNCHING ALL 4 MLP METHODS IN PARALLEL${NC}"
echo -e "${BLUE}  NOTE: Method-specific params not yet implemented${NC}"
echo -e "${BLUE}  MOON: varying tau | FedALA: varying tau${NC}"
echo -e "${BLUE}  StatAvg: varying slr | DASHA: varying slr${NC}"
echo -e "${BLUE}  Each method: 4 alphas Ã— 3 values = 12 experiments${NC}"
echo -e "${BLUE}  Total: 48 MLP experiments${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

# Start all 4 server scripts in parallel (detached)
sudo docker exec -d fl_moon_server bash /workspace/moon_server_mlp.sh
sudo docker exec -d fl_fedala_server bash /workspace/fedala_server_mlp.sh
sudo docker exec -d fl_statavg_server bash /workspace/statavg_server_mlp.sh
sudo docker exec -d fl_dasha_server bash /workspace/dasha_server_mlp.sh

echo -e "${GREEN}âœ“ All 4 MLP methods started!${NC}\n"

echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}  MLP EXPERIMENTS RUNNING${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"

echo -e "${YELLOW}ðŸ“Š Monitor progress:${NC}"
echo -e "  docker logs -f fl_moon_server     # MOON (varying tau)"
echo -e "  docker logs -f fl_fedala_server   # FedALA (varying tau)"
echo -e "  docker logs -f fl_statavg_server  # StatAvg (varying slr)"
echo -e "  docker logs -f fl_dasha_server    # DASHA (varying slr)"
echo -e ""
echo -e "${YELLOW}ðŸ“ Output files in containers:${NC}"
echo -e "  docker exec fl_moon_server ls -la /workspace/MLP_MOON_*.txt"
echo -e "  docker exec fl_fedala_server ls -la /workspace/MLP_FedALA_*.txt"
echo -e "  docker exec fl_statavg_server ls -la /workspace/MLP_StatAvg_*.txt"
echo -e "  docker exec fl_dasha_server ls -la /workspace/MLP_DASHA_*.txt"
echo -e ""

# Monitor loop
echo -e "${YELLOW}Press Ctrl+C to stop monitoring (experiments continue in background)${NC}\n"

while true; do
    sleep 30
    echo -e "${BLUE}â•â•â• MLP Status $(date +%H:%M:%S) â•â•â•${NC}"
    
    for method in moon fedala statavg dasha; do
        container="fl_${method}_server"
        if sudo docker exec $container pgrep -f "federated_server_OFFSET" > /dev/null 2>&1; then
            count=$(sudo docker exec $container ls /workspace/MLP_*.txt 2>/dev/null | wc -l || echo 0)
            echo -e "${GREEN}âœ“ ${method^^}: Running (${count} logs)${NC}"
        else
            count=$(sudo docker exec $container ls /workspace/MLP_*.txt 2>/dev/null | wc -l || echo 0)
            echo -e "${YELLOW}â¦¿ ${method^^}: Done (${count} logs)${NC}"
        fi
    done
    echo ""
done
